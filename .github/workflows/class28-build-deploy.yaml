name: class28 build deploy argo

on:
  # push:
  #   branches: [ main ]
  #   paths:
  #     - 'class28-29/microservices-on-k8s/app/**'
  workflow_dispatch:

env:
  AWS_REGION: ap-south-1
  ECR_REGISTRY: 879381241087.dkr.ecr.ap-south-1.amazonaws.com

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        service:
          - name: frontend
            ecr_repo: devopsbootcamp-dev-frontend
          - name: catalogue
            ecr_repo: devopsbootcamp-dev-catalogue
          - name: voting
            ecr_repo: devopsbootcamp-dev-voting
          - name: recommendation
            ecr_repo: devopsbootcamp-dev-recommendations

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v2

    - name: Generate image tag
      id: image-tag
      run: |
        SHORT_SHA=${GITHUB_SHA::8}
        IMAGE_TAG="v$(date +%Y%m%d)-${SHORT_SHA}"
        echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
        echo "Generated image tag: ${IMAGE_TAG}"

    - name: Build and push ${{ matrix.service.name }}
      uses: docker/build-push-action@v5
      with:
        context: ./class28-29/microservices-on-k8s/app/${{ matrix.service.name }}
        file: ./class28-29/microservices-on-k8s/app/${{ matrix.service.name }}/Dockerfile
        push: true
        tags: |
          ${{ env.ECR_REGISTRY }}/${{ matrix.service.ecr_repo }}:${{ steps.image-tag.outputs.image_tag }}
          ${{ env.ECR_REGISTRY }}/${{ matrix.service.ecr_repo }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Update Kubernetes deployment manifest
      run: |
        # Map service names to deployment files
        case "${{ matrix.service.name }}" in
          frontend)
            DEPLOY_FILE="02-frontend-deployment.yaml"
            ;;
          catalogue)
            DEPLOY_FILE="03-catalogue-deployment.yaml"
            ;;
          voting)
            DEPLOY_FILE="04-voting-deployment.yaml"
            ;;
          recommendation)
            DEPLOY_FILE="05-recommendation-deployment.yaml"
            ;;
        esac

        # Update the image in the deployment file
        sed -i "s|image:.*${{ matrix.service.name }}.*|image: ${{ env.ECR_REGISTRY }}/${{ matrix.service.ecr_repo }}:${{ steps.image-tag.outputs.image_tag }}|g" \
          ./class28-29/microservices-on-k8s/k8s-menifest-adv/${DEPLOY_FILE}

        echo "Updated ${DEPLOY_FILE} with new image tag"

    - name: Commit and push updated manifests
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add class28-29/microservices-on-k8s/k8s-menifest-adv/*.yaml
        git diff --staged --quiet || git commit -m "Update ${{ matrix.service.name }} image to ${{ steps.image-tag.outputs.image_tag }}"
        git pull --rebase origin main
        git push

    - name: Summary
      run: |
        echo " Built and pushed ${{ matrix.service.name }}" >> $GITHUB_STEP_SUMMARY
        echo "Image: ${{ env.ECR_REGISTRY }}/${{ matrix.service.ecr_repo }}:${{ steps.image-tag.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
        echo "Updated deployment manifest with new image" >> $GITHUB_STEP_SUMMARY
